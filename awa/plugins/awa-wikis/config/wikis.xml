<?xml version="1.0" encoding="UTF-8"?>
<module version="1.0">

  <managed-bean>
    <description>The wiki page with all its information to display it.</description>
    <managed-bean-name>wikiView</managed-bean-name>
    <managed-bean-class>AWA.Wikis.Beans.Wiki_View_Bean</managed-bean-class>
    <managed-bean-scope>request</managed-bean-scope>
  </managed-bean>

  <managed-bean>
    <description>The list of wikis and pages that the current user can access and update.</description>
    <managed-bean-name>adminWiki</managed-bean-name>
    <managed-bean-class>AWA.Wikis.Beans.Wiki_Admin_Bean</managed-bean-class>
    <managed-bean-scope>request</managed-bean-scope>
  </managed-bean>

  <managed-bean>
    <description>The wiki space bean to create and edit the wiki space configuration.</description>
    <managed-bean-name>adminWikiSpace</managed-bean-name>
    <managed-bean-class>AWA.Wikis.Beans.Wiki_Space_Bean</managed-bean-class>
    <managed-bean-scope>request</managed-bean-scope>
  </managed-bean>

  <managed-bean>
    <description>The wiki page bean gives the full content and information about a wiki page.</description>
    <managed-bean-name>wikiPage</managed-bean-name>
    <managed-bean-class>AWA.Wikis.Beans.Wiki_Page_Bean</managed-bean-class>
    <managed-bean-scope>request</managed-bean-scope>
  </managed-bean>

  <managed-bean>
    <description>The list of wiki pages.</description>
    <managed-bean-name>wikiPages</managed-bean-name>
    <managed-bean-class>AWA.Wikis.Beans.Wiki_List_Bean</managed-bean-class>
    <managed-bean-scope>request</managed-bean-scope>
  </managed-bean>

  <managed-bean>
    <description>The wiki tag search bean.</description>
    <managed-bean-name>wikiTagSearch</managed-bean-name>
    <managed-bean-class>AWA.Tags.Beans.Tag_Search_Bean</managed-bean-class>
    <managed-bean-scope>request</managed-bean-scope>
    <managed-property>
      <property-name>entity_type</property-name>
      <property-class>String</property-class>
      <value>awa_wiki_page</value>
    </managed-property>
  </managed-bean>

  <managed-bean>
    <description>The list of tags associated with a wiki page entities.</description>
    <managed-bean-name>wikiTagCloud</managed-bean-name>
    <managed-bean-class>AWA.Tags.Beans.Tag_Info_List_Bean</managed-bean-class>
    <managed-bean-scope>request</managed-bean-scope>
    <managed-property>
      <property-name>entity_type</property-name>
      <property-class>String</property-class>
      <value>awa_wiki_page</value>
    </managed-property>
  </managed-bean>

  <managed-bean>
    <description>The wiki tag editor bean.</description>
    <managed-bean-name>wikiTags</managed-bean-name>
    <managed-bean-class>AWA.Tags.Beans.Tag_List_Bean</managed-bean-class>
    <managed-bean-scope>request</managed-bean-scope>
    <managed-property>
      <property-name>entity_type</property-name>
      <property-class>String</property-class>
      <value>awa_wiki_page</value>
    </managed-property>
    <managed-property>
      <property-name>permission</property-name>
      <property-class>String</property-class>
      <value>wiki-page-edit</value>
    </managed-property>
  </managed-bean>

  <navigation-rule>
    <from-view-id>/wikis/admin/forms/create.xhtml</from-view-id>
    <navigation-case>
      <from-outcome>success</from-outcome>
      <to-view-id>/wikis/admin/forms/create-response.xhtml</to-view-id>
    </navigation-case>
  </navigation-rule>

  <navigation-rule>
    <from-view-id>/wikis/admin/create-page.xhtml</from-view-id>
    <navigation-case>
      <from-outcome>success</from-outcome>
      <to-view-id>/wikis/admin/view.xhtml?wiki=#{wikiPage.wikiId}&amp;page=#{wikiPage.name}</to-view-id>
      <redirect/>
    </navigation-case>
  </navigation-rule>

  <filter-mapping>
    <filter-name>service</filter-name>
    <url-pattern>/wikis/view/#{wikiView.wikiId}/#{wikiView.name}</url-pattern>
    <url-pattern>/wikis/edit/#{wikiPage.wikiId}/#{wikiPage.name}</url-pattern>
    <url-pattern>/wikis/*.html</url-pattern>
  </filter-mapping>

  <filter-mapping>
    <filter-name>auth-filter</filter-name>
    <url-pattern>/wikis/edit/#{wikiPage.wikiId}/#{wikiPage.name}</url-pattern>
    <url-pattern>/wikis/*.html</url-pattern>
  </filter-mapping>

    <entity-permission>
        <name>wiki-space-create</name>
        <entity-type>awa_workspace</entity-type>
        <sql>
            select ACL.ID from awa_acl AS ACL
            where ACL.ENTITY_TYPE = :entity_type
            and ACL.USER_ID = :user_id
        </sql>
    </entity-permission>

    <entity-permission>
        <name>wiki-space-update</name>
        <entity-type>awa_wiki_space</entity-type>
        <description>Grant the edit permission on the wiki space owner only</description>
        <sql>
            SELECT acl.id FROM awa_acl AS acl
            WHERE acl.entity_type = :entity_type
            AND acl.user_id = :user_id
            AND acl.entity_id = :entity_id
        </sql>
    </entity-permission>

    <entity-permission>
        <name>wiki-space-delete</name>
        <entity-type>awa_wiki_space</entity-type>
        <description>Grant the delete permission on the wiki space owner only</description>
        <sql>
            SELECT acl.id FROM awa_acl AS acl
            WHERE acl.entity_type = :entity_type
            AND acl.user_id = :user_id
            AND acl.entity_id = :entity_id
        </sql>
    </entity-permission>

    <entity-permission>
        <name>wiki-page-view</name>
        <entity-type>awa_wiki_space</entity-type>
        <description>Grant the view wiki page permission when the page is public
                     or when an ACL link exist betwen the user and the wiki space</description>
        <sql>
       SELECT page.id FROM awa_wiki_page AS page
       LEFT JOIN awa_acl AS acl ON acl.entity_type = :entity_type AND acl.entity_id = page.wiki_id AND acl.user_id = :user_id
       WHERE page.id = :entity_id AND (page.is_public OR acl.id IS NOT NULL)
        </sql>
    </entity-permission>

    <entity-permission>
        <name>wiki-page-create</name>
        <entity-type>awa_wiki_space</entity-type>
        <description>Grant the create wiki page permission when an ACL link exist betwen the user and the wiki space</description>
        <sql>
            SELECT acl.id FROM awa_acl AS acl
            WHERE acl.entity_type = :entity_type
            AND acl.user_id = :user_id
            AND acl.entity_id = :entity_id
        </sql>
    </entity-permission>

  <entity-permission>
    <name>wiki-page-update</name>
    <entity-type>awa_wiki_space</entity-type>
    <sql>
       SELECT acl.id FROM awa_wiki_page AS page
       INNER JOIN awa_acl AS acl ON acl.entity_type = :entity_type AND acl.entity_id = page.wiki_id
       WHERE page.id = :entity_id
       AND acl.user_id = :user_id
    </sql>
  </entity-permission>

  <entity-permission>
    <name>wiki-page-delete</name>
    <entity-type>awa_wiki_space</entity-type>
    <sql>
       SELECT acl.id FROM awa_wiki_page AS page
       INNER JOIN awa_acl AS acl ON acl.entity_type = :entity_type AND acl.entity_id = page.wiki_id
       WHERE page.id = :entity_id
       AND acl.user_id = :user_id
    </sql>
  </entity-permission>

  <url-policy>
    <permission>logged-user</permission>
    <url-pattern>/wikis/admin/.*</url-pattern>
    <url-pattern>/wikis/edit/.*</url-pattern>
  </url-policy>

  <url-policy>
    <permission>logged-user</permission>
    <url-pattern>/wikis/view/.*</url-pattern>
  </url-policy>

  <url-mapping>
    <pattern>/wikis/view/#{wikiView.wikiId}/#{wikiView.name}</pattern>
    <view-id>/wikis/view.html</view-id>
  </url-mapping>

  <url-mapping>
    <pattern>/wikis/edit/#{wikiPage.wikiId}/#{wikiPage.name}</pattern>
    <view-id>/wikis/edit.html</view-id>
  </url-mapping>

</module>
